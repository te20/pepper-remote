<!DOCTYPE html>
<html lang="ja-JP">

<head>
    <meta charset="UTF-8">
    <title>canvasApp</title>
</head>

<body onload="init()">
    <canvas id="first" style="background-color: black;"></canvas>

    <audio id="bgm0" src="OneMoreTime.ogg"></audio>
    <audio id="bgm1" src="Collide.wav"></audio>
    <audio id="bgm2" src="タカラモノズ.wav"></audio>
    <audio id="bgm3" src="僕の言葉ではない.wav"></audio>
    <audio id="bgm4" src="マジLOVE2000%.wav"></audio>

    <audio id="audio1" src="1.wav"></audio>
    <audio id="audio2" src="2.wav"></audio>
    <audio id="audio3" src="3.wav"></audio>
    <audio id="audio4" src="4.wav"></audio>
    <audio id="audio5" src="5.wav"></audio>
    <audio id="audio6" src="6.wav"></audio>
    <audio id="audio7" src="7.wav"></audio>
    <audio id="audio8" src="8.wav"></audio>
    <audio id="audio9" src="9.wav"></audio>
    <audio id="audio10" src="10.wav"></audio>
    <audio id="audio11" src="11.wav"></audio>
    <audio id="audio12" src="12.wav"></audio>
    <audio id="audio13" src="13.wav"></audio>
    <audio id="audio14" src="14.wav"></audio>
    <audio id="audio15" src="15.wav"></audio>
    <audio id="audio16" src="16.wav"></audio>
    <audio id="audio17" src="17.wav"></audio>
    <audio id="audio18" src="18.wav"></audio>
    <audio id="audio19" src="19.wav"></audio>
    <audio id="audio20" src="20.wav"></audio>

    <script>
        var canvas = document.getElementById('first');
        //canvas.width = window.innerWidth;
        //canvas.height = window.innerHeight;//画面下端にボタンを表示するために少し小さくしている
        canvas.width = 980;
        canvas.height = 680;

        var KEEPALIVE_INTERVAL = 60000;
        var keepalive_count = 30;

        var ctx = canvas.getContext('2d');

        var s = [550, 550, 550, 550, 550];
        var grad = [];
        var count1 = 0;
        var count2 = 0;
        var count3 = 0;
        var count4 = 0;
        var count5 = 0;
        var second = 0;
        var audio = [audio1, audio2, audio3, audio4, audio5, audio6, audio7, audio8, audio9, audio10, audio11, audio12, audio13, audio14, audio15, audio16, audio17, audio18, audio19, audio20];
        var user = ["A", "B", "C", "D", "E"];
        var bgm = [bgm0, bgm1, bgm2, bgm3, bgm4];

        var webSocket = null; // webSocketが接続しているか？
        ctx.fillStyle = "#F0F8FF";
        ctx.font = "80px Arial";

        var score = [];
        var prev_score = [0, 0, 0, 0, 0];
        var stat = [];

        /* グラデーション領域をセット */
        grad[1] = ctx.createLinearGradient(0, 0, 0, 500);
        //CanvasGradient = ctx.createLinearGradient(x0, y0, x1, y1)
        //グラデーションの開始地点(x0, y0)と終了地点(x1, y1)をセット
        /* グラデーション終点のオフセットと色をセット */
        grad[1].addColorStop(0, 'rgb(255, 0, 0)'); // 赤
        grad[1].addColorStop(0.9, 'rgb(255, 255, 0)'); // 黄
        /* グラデーションをfillStyleプロパティにセット */
        // ctx.fillStyle = grad1;

        grad[2] = ctx.createLinearGradient(0, 0, 0, 500);
        grad[2].addColorStop(0, 'rgb(255, 255, 0)');
        grad[2].addColorStop(0.9, 'rgb(0, 255, 0)');

        grad[3] = ctx.createLinearGradient(0, 0, 0, 500);
        grad[3].addColorStop(0, 'rgb(0, 255, 0)');
        grad[3].addColorStop(0.9, 'rgb(0, 255, 255)');

        grad[4] = ctx.createLinearGradient(0, 0, 0, 500);
        grad[4].addColorStop(0, 'rgb(0, 255, 255)');
        grad[4].addColorStop(0.9, 'rgb(0, 0, 255)');

        grad[5] = ctx.createLinearGradient(0, 0, 0, 500);
        grad[5].addColorStop(0, 'rgb(0, 0, 255)');
        grad[5].addColorStop(0.9, 'rgb(255, 0, 255)');

        var r = Math.floor(Math.random() * 5);

        function drawbutton() {
                //スタートボタンの作成
                ctx.fillStyle = "#00FF00";
                ctx.fillRect(canvas.width / 4, canvas.height / 3, canvas.width / 2, canvas.height / 6);
                ctx.font = "60px Arial";
                ctx.fillStyle = "#FFFFFF";
                ctx.fillText("START", canvas.width / 3 + 60, canvas.height / 2 - 40);

                //リセットボタンの作成
                ctx.fillStyle = "#FF0000";
                ctx.fillRect(canvas.width / 4, canvas.height / 3 + 150, canvas.width / 2, canvas.height / 6);
                ctx.font = "60px Arial";
                ctx.fillStyle = "#FFFFFF";
                ctx.fillText("RESET", canvas.width / 3 + 60, canvas.height / 2 + 110);
            }
            /*
                    //スタートクリック範囲
                    ctx.fillStyle ="#00FFFF";
                    ctx.fillRect(0, canvas.height / 2 , canvas.width, -canvas.height / 6);
                    //リセットクリック範囲
                    ctx.fillStyle ="#FFFF00";
                    ctx.fillRect(0, canvas.height / 2  , canvas.width, canvas.height / 6);
            */
        function init() {

            bgm[r].volume = 0;
            drawbutton();
            // ボタンのクリック処理
            canvas.addEventListener('click', function (e) {
                //count2++;
                var mouse_x = 0;
                var mouse_y = 0;
                mouse_x = e.clientX;
                mouse_y = e.clientY;
                //if (count2 == 1) {
                console.log(mouse_y);
                console.log(canvas.height);
                console.log(canvas.height / 2);

                //if (mouse_y > canvas.height / 2 - 150 && mouse_y < canvas.height / 2) {
                if (mouse_y < canvas.height / 2) {
                    webSocket.send(JSON.stringify({
                        type: 'start',
                        value: ''
                    }));
                    bgm[r].play();
                    ctx.clearRect(canvas.width / 4, canvas.height / 4, canvas.width / 2 + 10, canvas.height / 2 + 10);
                }
                //if (mouse_y > canvas.height / 2 && mouse_y < canvas.height / 3+250) {
                //if (mouse_y > canvas.height / 2 + 20 ) {
                else {
                    webSocket.send(JSON.stringify({
                        type: 'reset',
                        value: ''
                    }));
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    drawbutton();
                    return;
                }
                //}
            }, false);

            // 棒グラフの下端を調整
            for (var i = 0; i < s.length; i++) {
                s[i] = canvas.height - 125;
            }
            //var r = Math.floor(Math.random() * 5);
            //bgm[r].volume = 0;
            //bgm[r].play();//音楽の再生

            // WebSocketサーバーのURLを生成
            var url = window.location;
            if (url.host !== '') {
                var ws_url = url.protocol === 'https:' ? 'wss:' : 'ws:' + '//' + url.host;
            } else {
                var ws_url = 'ws://shake.elasticbeanstalk.com/';
            }
            // var ws_url = 'ws://shake.elasticbeanstalk.com/';　// テスト用に強制的に書き換え
            console.log('WebSocket Host: ' + ws_url);

            // WebSocketサーバーに接続
            webSocket = new WebSocket(ws_url);
            webSocket.onopen = function () {
                // クライアントの種類（スマホかスコア表示用PC）を送信
                webSocket.send(JSON.stringify({
                    type: 'join',
                    value: 'scoreboard'
                }));


                webSocket.onmessage = function (e) { // サーバーからデータが届いた
                    var message = JSON.parse(e.data);

                    // サーバーから送られた名前と点数を記録
                    if (message.type === 'scores') {
                        var scores = message.value;
                        console.log(scores);
                        var i = 0;
                        for (u in scores) {
                            user[i] = u;
                            score[i] = scores[u].score;
                            stat[i] = scores[u].status; // 'DISCONNECT', "WATING', 'GAMING', 'GAME_END'
                            i++;
                        }

                        // サーバーからのデータが５個未満の場合、残りを''と０にする
                        for (; i < 5; i++) {
                            user[i] = '';
                            score[i] = 0;
                            stat[i] = '';
                        }

                        draw();
                    } else {
                        console.log('Unknown message type: ', e.data);
                    }
                };
            };

            setTimeout(function keepalive() {
                if (keepalive_count-- > 0) {
                    webSocket.send(JSON.stringify({
                        type: 'iamalive',
                        value: 0
                    }));
                    setTimeout(keepalive, KEEPALIVE_INTERVAL);
                }
            }, KEEPALIVE_INTERVAL);

        }


        // グラフを書く
        function draw() {

            console.log(user);
            console.log(score);

            //音楽の再生・音量の調節
            var v = second / 1000;
            if (v > 0.2) {
                v = 0.2;
            }
            //bgm[r].play();
            bgm[r].volume = v;
            second++;

            //下のアルファベットの表示
            var bar_width = canvas.width / 5;
            ctx.clearRect(0, canvas.height, canvas.width, -90);
            for (var i = 0; i < 5; i++) {

                ctx.font = "80px Arial";
                ctx.fillStyle = "#F0F8FF";
                ctx.fillText(user[i], 30 + bar_width * i, canvas.height - 30);

                //呼ばれるたびに点数を消す
                //ctx.clearRect(115 + bar_width * i, canvas.height - 30, 130, -50);

                //点数の表示
                ctx.font = "50px Arial";
                ctx.fillStyle = "#F0F8FF";
                ctx.fillText(score[i], 100 + bar_width * i, canvas.height - 30);
            }

            //バーの表示
            for (var j = 0; j < 5; j++) {
                //スコアが１０ごとにバーを書くようにする
                if (score[j] % 20 != 0) {
                    continue;
                }

                //audioの調節
                if (score[0] > prev_score[0] && score[0] % 20 == 0) {
                    //audio[count].volume = 1;
                    audio[count1].play();
                    count1++;
                }

                if (score[1] > prev_score[1] && score[1] % 20 == 0) {
                    //audio[count].volume = 1;
                    audio[count2].play();
                    count2++;
                }
                if (score[2] > prev_score[2] && score[2] % 20 == 0) {
                    //audio[count].volume = 1;
                    audio[count3].play();
                    count3++;
                }

                if (score[3] > prev_score[3] && score[3] % 20 == 0) {
                    //audio[count].volume = 1;
                    audio[count4].play();
                    count4++;
                }
                if (score[4] > prev_score[4] && score[4] % 20 == 0) {
                    //audio[count].volume = 1;
                    audio[count5].play();
                    count5++;
                }

                ctx.fillStyle = grad[j + 1];
                console.log(score[j]);
                ctx.fillRect(20 + bar_width * j, s[j], bar_width * 0.8, -score[j] * 2);

                //s[j] = s[j] + (prev_score[j]-score[j]);
                prev_score[j] = score[j];

            }

            var gaming = 0;
            for (i = 0; i < stat.length; i++) {
                if (user[i] !== '') {
                    gaming += (stat[i] === 'GAMING' || stat[i] === 'WAITING') ? 1 : 0;
                }
            }
            if (gaming === 0) {
                alert('ゲーム終了です!!');
                console.log('Game Over!');
            }
        }
    </script>

</body>

</html>